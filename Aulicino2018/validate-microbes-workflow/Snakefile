from os.path import join
import pandas as pd

# urls
LT2_genome_URL = "ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/006/945/GCF_000006945.2_ASM694v2/GCF_000006945.2_ASM694v2_genomic.fna.gz"

# files
LT2_FA = join("raw", "Salmonella-LT2.fa")
LT2_SRPRISM_DB_DIR = join("output", "LT2_db")
LT2_SRPRISM_DB_PREFIX = join("output", "LT2_db", "LT2")
LT2_SRPRISM_DB_FILE = join("output", "LT2_db", "LT2.idx")

PathSeq_BAM = join("..", "identify-microbes-workflow", "output", "PathSeq", "{patient}-{sample}", "pathseq.bam")
PathSeq_FQ1 = join("output", "{patient}-{sample}", "pathseq_1.fq")
PathSeq_FQ2 = join("output", "{patient}-{sample}", "pathseq_2.fq")
PathSeq_FQ3 = join("output", "{patient}-{sample}", "pathseq_3.fq")
SRPRISM_LT2_PAIRED_SAM = join("output", "SRPRISM", "{patient}-{sample}", "LT2_paired.sam")
SRPRISM_LT2_UNPAIRED_SAM = join("output", "SRPRISM", "{patient}-{sample}", "LT2_unpaired.sam")

samples = pd.read_csv("../identify-microbes-workflow/data/samples.tsv", dtype=str, sep="\t")
samples = samples.loc[samples.infection == "LT2"]

rule all:
    input:
        expand(SRPRISM_LT2_PAIRED_SAM, patient="Pt0", sample=samples["sample"]),
        expand(SRPRISM_LT2_UNPAIRED_SAM, patient="Pt0", sample=samples["sample"])

rule map_SRPRISM_LT2_genome_unpaired:
    params:
        LT2_SRPRISM_DB_PREFIX
    input:
        PathSeq_FQ3,
        LT2_SRPRISM_DB_FILE
    output:
        SRPRISM_LT2_UNPAIRED_SAM
    shell:
        "srprism search -I {params} -i {input[0]} -F fastq -p false -o {output}"

rule map_SRPRISM_LT2_genome_paired:
    params:
        LT2_SRPRISM_DB_PREFIX
    input:
        PathSeq_FQ1,
        PathSeq_FQ2,
        LT2_SRPRISM_DB_FILE
    output:
        SRPRISM_LT2_PAIRED_SAM
    shell:
        "srprism search -I {params} -i {input[0]},{input[1]} -F fastq -p true -o {output}"

rule convert_BAM_to_paired_FASTQ:
    input:
        PathSeq_BAM
    output:
        PathSeq_FQ1,
        PathSeq_FQ2,
        PathSeq_FQ3
    shell:
        "module load picard && "
        "java -jar $PICARDJARPATH/picard.jar SamToFastq I={input} "
        "F={output[0]} F2={output[1]} FU={output[2]}"

rule make_SRPRISM_DB:
    params:
        LT2_SRPRISM_DB_PREFIX,
        LT2_SRPRISM_DB_DIR
    input:
        LT2_FA
    output:
        LT2_SRPRISM_DB_FILE
    shell:
        #"mkdir {params[1]} && "
        "srprism mkindex -i {input} -o {params[0]}"

rule download_LT2_genome:
    params:
        LT2_genome_URL
    output:
        LT2_FA
    shell:
        "wget -O - {params} | gunzip -c > {output} "

# wget -O - {params.FA_URL} | gunzip -c > {output.FA}
